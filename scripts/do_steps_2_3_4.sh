#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —à–∞–≥–æ–≤ 2-4: –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ Git LFS
# –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –≤–∞—à–µ–º Mac, –≥–¥–µ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ª–æ–∫–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º

set -e

echo "="*60
echo "üìã –®–∞–≥–∏ 2-4: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ Git LFS"
echo "="*60

# –®–∞–≥ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
echo ""
echo "üìã –®–∞–≥ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö..."
echo ""

SOURCE_DIR="/Users/evgenyglazeykin/Yandex.Disk-eglazejkin.localized/Cursor_happy/data/v1/curated/ctrader"
TARGET_DIR="data/v1/curated/ctrader"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–π –ø–∞–ø–∫–∏
if [ ! -d "$SOURCE_DIR" ]; then
    echo "‚ùå –ò—Å—Ö–æ–¥–Ω–∞—è –ø–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $SOURCE_DIR"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
mkdir -p "$TARGET_DIR"

# –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
echo "üîÑ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ $SOURCE_DIR..."
cp "$SOURCE_DIR"/*.parquet "$TARGET_DIR/" 2>/dev/null || {
    echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞."
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã
PARQUET_COUNT=$(find "$TARGET_DIR" -name "*.parquet" | wc -l)
if [ "$PARQUET_COUNT" -eq 0 ]; then
    echo "‚ùå –§–∞–π–ª—ã –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
    exit 1
fi

echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ $PARQUET_COUNT —Ñ–∞–π–ª–æ–≤"
ls -lh "$TARGET_DIR"/*.parquet | head -5

# –®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ Git LFS
echo ""
echo "üìã –®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Git LFS..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Git LFS
if ! command -v git-lfs &> /dev/null; then
    echo "‚ùå Git LFS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install git-lfs"
    exit 1
fi

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ Git LFS
git add "$TARGET_DIR"/*.parquet

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —á–µ—Ä–µ–∑ LFS
echo "üìä –§–∞–π–ª—ã —á–µ—Ä–µ–∑ Git LFS:"
git lfs ls-files

# –®–∞–≥ 4: –ö–æ–º–º–∏—Ç –∏ push
echo ""
echo "üìã –®–∞–≥ 4: –ö–æ–º–º–∏—Ç –∏ push..."
echo ""

# –ö–æ–º–º–∏—Ç–∏–º
git commit -m "Add forex data files via Git LFS"

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ –∫ push!"
echo ""
echo "üí° –í—ã–ø–æ–ª–Ω–∏—Ç–µ: git push"
echo "   –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ Git LFS"
