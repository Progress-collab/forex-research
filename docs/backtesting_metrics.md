# Метрики бэктестинга форекс-стратегий

## Обзор метрик

Этот документ описывает метрики, используемые для оценки производительности форекс-стратегий, их расчет и интерпретацию.

---

## Метрики доходности

### Net PnL (Net Profit and Loss)

**Описание:** Чистая прибыль/убыток после учета всех комиссий и свопов.

**Формула:**
```
Net PnL = Σ(Gross PnL) - Commission - Swap
```

**Интерпретация:**
- Положительное значение: стратегия прибыльна
- Отрицательное значение: стратегия убыточна
- Учитывает реальные торговые издержки

**Единицы:** Валюта счета (обычно USD)

---

### Total PnL

**Описание:** Валовая прибыль/убыток до учета комиссий и свопов.

**Использование:** Для анализа эффективности самой стратегии без учета издержек.

---

## Метрики риска

### Max Drawdown (Максимальная просадка)

**Описание:** Максимальное падение equity от пика до минимума.

**Формула:**
```
Max Drawdown = min((Equity_t / Peak_t) - 1)
```

Где:
- `Equity_t` - текущий equity
- `Peak_t` - максимальный equity до момента t

**Интерпретация:**
- Выражается в процентах (например, -15%)
- Показывает максимальный риск стратегии
- Критический лимит: -20% для консервативных стратегий

**Пример:**
- Начальный капитал: $100,000
- Пик: $120,000
- Минимум после пика: $102,000
- Max Drawdown = (102,000 / 120,000) - 1 = -15%

---

### Recovery Factor

**Описание:** Способность стратегии восстанавливаться после просадок.

**Формула:**
```
Recovery Factor = Total Net PnL / |Max Drawdown * Initial Capital|
```

**Интерпретация:**
- Recovery Factor > 2.0: хорошая способность к восстановлению
- Recovery Factor > 5.0: отличная способность к восстановлению
- Recovery Factor < 1.0: стратегия не восстанавливается после просадок

**Пример:**
- Total Net PnL: $20,000
- Max Drawdown: -15%
- Initial Capital: $100,000
- Recovery Factor = 20,000 / (0.15 * 100,000) = 1.33

---

## Метрики эффективности

### Sharpe Ratio

**Описание:** Отношение избыточной доходности к волатильности (риску).

**Формула:**
```
Sharpe Ratio = (R_p - R_f) / σ_p * √252
```

Где:
- `R_p` - средняя доходность портфеля (дневная)
- `R_f` - безрисковая ставка (дневная, обычно 0)
- `σ_p` - стандартное отклонение доходности
- `√252` - годовое масштабирование (252 торговых дня)

**Интерпретация:**
- Sharpe > 1.0: приемлемая производительность
- Sharpe > 2.0: отличная производительность
- Sharpe > 3.0: выдающаяся производительность
- Sharpe < 0: стратегия хуже безрискового актива

**Особенности:**
- Учитывает волатильность доходности
- Полезен для сравнения стратегий с разным риском
- Чувствителен к выбросам

---

### Sortino Ratio

**Описание:** Аналогичен Sharpe Ratio, но учитывает только downside волатильность.

**Формула:**
```
Sortino Ratio = (R_p - R_f) / σ_downside * √252
```

Где `σ_downside` - стандартное отклонение только отрицательных доходностей.

**Преимущества:**
- Фокус на downside риске (что важно для трейдеров)
- Менее чувствителен к выбросам вверх

---

## Метрики торговой статистики

### Win Rate (Процент прибыльных сделок)

**Описание:** Процент сделок, завершившихся прибылью.

**Формула:**
```
Win Rate = (Winning Trades / Total Trades) * 100%
```

**Интерпретация:**
- Зависит от типа стратегии:
  - Mean Reversion: обычно 50-70%
  - Momentum/Breakout: обычно 40-55%
- Высокий Win Rate не гарантирует прибыльность (важен также размер выигрышей)

**Пример:**
- 60 прибыльных сделок из 100
- Win Rate = 60%

---

### Profit Factor

**Описание:** Отношение валовой прибыли к валовым убыткам.

**Формула:**
```
Profit Factor = Gross Profit / |Gross Loss|
```

Где:
- `Gross Profit` = сумма всех прибыльных сделок
- `Gross Loss` = сумма всех убыточных сделок (по модулю)

**Интерпретация:**
- Profit Factor > 1.0: стратегия прибыльна
- Profit Factor > 1.5: хорошая стратегия
- Profit Factor > 2.0: отличная стратегия
- Profit Factor < 1.0: стратегия убыточна

**Пример:**
- Gross Profit: $30,000
- Gross Loss: $15,000
- Profit Factor = 30,000 / 15,000 = 2.0

---

### Average Win / Average Loss

**Описание:** Средний размер прибыльной и убыточной сделки.

**Формула:**
```
Average Win = Σ(Winning Trades) / Count(Winning Trades)
Average Loss = Σ(Losing Trades) / Count(Losing Trades)
```

**Интерпретация:**
- Соотношение Average Win / Average Loss должно быть > 1.0 для прибыльности
- Полезно для анализа соотношения риск/награда

---

## Метрики издержек

### Total Commission

**Описание:** Общая сумма комиссий за все сделки.

**Формула:**
```
Total Commission = Σ(Notional_i * Commission Rate) * 2
```

Где умножение на 2 учитывает вход и выход из позиции.

**Единицы:** Валюта счета

---

### Total Swap

**Описание:** Общая сумма свопов (overnight fees).

**Формула:**
```
Total Swap = Σ(Notional_i * Swap Rate_i * Days Held_i)
```

**Особенности:**
- Может быть положительным (получение свопа) или отрицательным (плата свопа)
- Зависит от направления позиции (long/short)
- Важно для carry стратегий

---

## Equity Curve

**Описание:** График изменения капитала во времени.

**Использование:**
- Визуальный анализ производительности
- Выявление периодов просадок
- Проверка стабильности роста

**Характеристики хорошей equity curve:**
- Плавный рост без резких падений
- Минимальные просадки
- Стабильность на разных периодах

---

## Интерпретация комбинаций метрик

### Хорошая стратегия:
- Sharpe Ratio > 1.5
- Recovery Factor > 2.0
- Max Drawdown < 15%
- Profit Factor > 1.5
- Win Rate > 45% (зависит от стратегии)

### Проблемные признаки:
- Высокий Sharpe, но низкий Recovery Factor → стратегия не восстанавливается после просадок
- Высокий Win Rate, но низкий Profit Factor → маленькие выигрыши, большие проигрыши
- Низкий Sharpe, но высокий Net PnL → высокая волатильность, нестабильность

---

## Рекомендации по использованию

1. **Не полагайтесь на одну метрику** - используйте комбинацию метрик
2. **Учитывайте контекст** - метрики зависят от типа стратегии и рыночных условий
3. **Проверяйте на разных периодах** - метрики могут сильно варьироваться
4. **Сравнивайте с бенчмарками** - например, buy-and-hold или безрисковая ставка
5. **Учитывайте транзакционные издержки** - реальная торговля всегда хуже бэктеста

---

## Ограничения метрик

- **Бэктест не гарантирует будущую производительность**
- **Slippage и execution delays** могут ухудшить результаты
- **Overfitting** может завышать метрики на исторических данных
- **Изменение рыночных условий** может сделать стратегию неэффективной

---

## Ссылки

- [Strategy Development Process](strategy_development_process.md)
- [Backtesting Framework](../src/backtesting/)

