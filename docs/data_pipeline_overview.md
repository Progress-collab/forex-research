# Конвейер данных по форекс-рынку

Документ описывает архитектуру и принципы эксплуатации пайплайна загрузки и подготовки данных для исследований форекс-стратегий.

## Источники данных
- **MOEX ISS API** — основной поставщик котировок USD/RUB, EUR/RUB и др. через двигатели `currency` и `futures`.
- **Макроэкономические данные** — планируется подключение (FRED, Росстат) на втором этапе.
- Все идентификаторы инструментов получаются из API (без жёстко прописанных кодов), с кэшированием запросов.

## Кэширование и сессии
- Для снижения нагрузки и повышения отказоустойчивости используется файловый кэш (`cache/api`) с настраиваемым TTL.
- Каждая комбинация эндпойнта и параметров хэшируется, что позволяет повторно использовать ответы и предотвращает случайные рассинхронизации.

## Версионирование данных
- Данные хранятся в каталоге `data/<версия>/{raw,curated,meta}` (по умолчанию `data/v1`).
- Сырые данные сохраняются в формате JSONL с временной меткой выгрузки, очищенные данные — в паркет (будет реализовано в следующей итерации).
- Метаданные и отчёты о валидации фиксируются отдельно, позволяя отслеживать качество данных и аудит изменений.

## Валидация качества
- Для каждого набора свечей выполняются проверки:
  - Наличие данных.
  - Соответствие схемы (open/close/high/low/volume/begin/end).
  - Отсутствие дубликатов по временной метке.
  - Сортировка по времени.
- Результаты валидируются и сохраняются вместе с данными.

## Процесс загрузки
1. Определение списка инструментов (`list_fx_instruments`).
2. Загрузка свечей с заданным интервалом (`ingest_instrument_history`).
3. Сохранение данных и отчёта о проверках.
4. (Опционально) Массовая загрузка `bulk_ingest`.
5. Для данных FXPro:
   - Разовая выгрузка: `python -m scripts.fetch_ctrader_trendbars --symbol EURUSD --period m15 --bars 1000 --output data/v1/raw/eurusd_m15.jsonl`
   - Бэкумы на длинный горизонт: `python -m scripts.backfill_ctrader_history --symbols EURUSD GBPUSD USDJPY XAUUSD --periods m1 m5 m15 --start 2025-05-01 --end 2025-11-01T00:00:00Z --raw-dir data/v1/raw/ctrader --curated-dir data/v1/curated/ctrader`
   - Ежедневное обновление (Prefect): `prefect deployment run ctrader-daily-backfill/deployment-name` (см. `research/flows/ctrader_daily.py`).

Сырые выгрузки хранятся в `data/v1/raw/ctrader/<symbol>/<period>/`, очищенные parquet — в `data/v1/curated/ctrader/`.

## Дальнейшие шаги
- Добавить нормализацию и агрегирование данных в `curated`.
- Интегрировать макроэкономические показатели.
- Автоматизировать расписание загрузки через Airflow или Prefect.

