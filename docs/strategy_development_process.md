# Процесс разработки и тестирования форекс-стратегий

## Обзор

Этот документ описывает итеративный процесс разработки, тестирования и развертывания алгоритмических форекс-стратегий. Процесс состоит из 6 этапов, каждый с четкими критериями перехода к следующему этапу.

## Этапы разработки

### Этап 1: Базовое тестирование

**Цель:** Проверка работоспособности стратегии и генерации сигналов.

**Действия:**
- Реализация базовой логики стратегии
- Тестирование на последних 500 барах данных
- Проверка генерации сигналов
- Базовая валидация логики

**Критерий перехода:** Стратегия успешно генерирует сигналы на тестовых данных.

**Инструменты:**
- `research/templates/backtest_template.py`
- `src/backtesting/runner.py` (limit=500)

---

### Этап 2: Расширенное тестирование

**Цель:** Оценка производительности стратегии на полных исторических данных.

**Действия:**
- Тестирование на полных годовых данных
- Расчет метрик: Sharpe Ratio, Max Drawdown, Recovery Factor, Win Rate, Profit Factor
- Анализ equity curve
- Учет комиссий и свопов

**Критерии перехода:**
- Sharpe Ratio > 1.0
- Recovery Factor > 2.0
- Max Drawdown < 20%
- Win Rate > 40% (зависит от стратегии)
- Положительный Net PnL

**Инструменты:**
- `src/backtesting/full_backtest.py`
- `scripts/run_full_backtests.py`

**Метрики:**
- **Sharpe Ratio**: Отношение средней доходности к волатильности (годовая)
- **Recovery Factor**: Отношение общего PnL к максимальной просадке
- **Max Drawdown**: Максимальная просадка от пика equity
- **Win Rate**: Процент прибыльных сделок
- **Profit Factor**: Отношение валовой прибыли к валовым убыткам

---

### Этап 3: Walk-forward валидация

**Цель:** Проверка стабильности стратегии на out-of-sample данных.

**Действия:**
- Разделение данных на тренировочные и тестовые периоды
- Тестирование на нескольких временных окнах
- Анализ деградации производительности
- Проверка стабильности параметров

**Критерии перехода:**
- Метрики на тестовых данных близки к тренировочным
- Деградация Sharpe Ratio < 30%
- Деградация Recovery Factor < 30%
- Стабильность параметров между периодами

**Инструменты:**
- `src/backtesting/walk_forward.py`

**Пример конфигурации:**
- Train: 6 месяцев
- Test: 3 месяца
- Step: 1 месяц (скользящее окно)

---

### Этап 4: Оптимизация параметров

**Цель:** Поиск оптимальных параметров стратегии.

**Действия:**
- Grid search по пространству параметров
- Оптимизация по целевой метрике (Sharpe или Recovery Factor)
- Валидация на out-of-sample данных
- Проверка на переобучение

**Критерии перехода:**
- Найдены стабильные оптимальные параметры
- Параметры работают на разных временных периодах
- Нет признаков переобучения

**Инструменты:**
- `src/backtesting/optimization.py`

**Важно:** Избегайте переобучения! Проверяйте параметры на независимых данных.

---

### Этап 5: Paper Trading

**Цель:** Тестирование стратегии в реальных рыночных условиях без риска.

**Действия:**
- Запуск стратегии в демо-режиме через cTrader API
- Мониторинг в реальном времени
- Сравнение результатов с бэктестом
- Анализ расхождений (slippage, execution delays)

**Критерии перехода:**
- Результаты paper trading соответствуют бэктесту (±20%)
- Стабильная работа в течение минимум 1 месяца
- Нет критических ошибок в исполнении

**Инструменты:**
- `src/execution/engine.py`
- `scripts/paper_dry_run.py`

**Мониторинг:**
- Сравнение PnL paper trading vs бэктест
- Анализ отклонений в исполнении
- Отслеживание ошибок и отклонений

---

### Этап 6: Live Trading

**Цель:** Запуск стратегии на реальном счете с постепенным масштабированием.

**Действия:**
- Запуск на реальном счете с минимальным капиталом
- Постепенное увеличение капитала при успехе
- Непрерывный мониторинг
- Автоматическое отключение при превышении лимитов риска

**Критерии успеха:**
- Стабильная прибыльность в течение 3+ месяцев
- Соответствие метрик бэктесту и paper trading
- Соблюдение лимитов риска

**Риск-менеджмент:**
- Максимальная просадка: автоматическое отключение при достижении лимита
- Ежедневные лимиты убытков
- Лимиты на размер позиций

---

## Метрики и критерии

### Ключевые метрики

1. **Sharpe Ratio**
   - Формула: `(R_p - R_f) / σ_p * √252`
   - Где R_p - средняя доходность, R_f - безрисковая ставка, σ_p - стандартное отклонение
   - Хорошее значение: > 1.0
   - Отличное значение: > 2.0

2. **Recovery Factor**
   - Формула: `Total PnL / |Max Drawdown|`
   - Показывает способность стратегии восстанавливаться после просадок
   - Хорошее значение: > 2.0
   - Отличное значение: > 5.0

3. **Max Drawdown**
   - Максимальная просадка от пика equity
   - Критический лимит: < 20% для консервативных стратегий
   - Допустимый лимит: < 30% для агрессивных стратегий

4. **Win Rate**
   - Процент прибыльных сделок
   - Зависит от стратегии (mean reversion обычно выше, чем momentum)
   - Минимум: 40%

5. **Profit Factor**
   - Формула: `Gross Profit / Gross Loss`
   - Хорошее значение: > 1.5
   - Отличное значение: > 2.0

### Критерии качества данных

- Минимум 1 год исторических данных для тестирования
- Отсутствие подозрительных разрывов (>72 часа, кроме выходных)
- Синхронизация данных между инструментами для pairs trading

---

## Процесс итеративного улучшения

1. **Анализ результатов бэктеста**
   - Выявление периодов низкой производительности
   - Анализ типов убыточных сделок
   - Поиск паттернов в прибыльных сделках

2. **Гипотезы улучшения**
   - Добавление фильтров (ADX, объем, сессии)
   - Корректировка параметров стоп-лоссов и тейк-профитов
   - Изменение логики генерации сигналов

3. **Тестирование гипотез**
   - Возврат к Этапу 2 (расширенное тестирование)
   - Сравнение метрик до и после изменений
   - Проверка на переобучение

4. **Валидация**
   - Walk-forward тестирование обновленной стратегии
   - Проверка стабильности улучшений

---

## Документация стратегий

Каждая стратегия должна иметь:
- Описание логики и индикаторов
- Параметры и их влияние
- Ожидаемые рыночные условия
- Известные ограничения
- Результаты бэктестинга

---

## Автоматизация

- Ежедневные бэктесты новых данных
- Автоматические алерты при деградации метрик
- Автоматическое отключение при превышении лимитов риска
- Логирование всех сделок и метрик

---

## Чеклист перед переходом к следующему этапу

- [ ] Все критерии текущего этапа выполнены
- [ ] Документация обновлена
- [ ] Метрики задокументированы
- [ ] Риски оценены
- [ ] План мониторинга подготовлен

