# Журнал разработки и оптимизации торговых стратегий

**Последнее обновление:** 2025-11-08 (добавлена задача об автоматическом выборе оптимального n_jobs)

## Содержание

1. [Обзор проекта](#обзор-проекта)
2. [История изменений стратегий](#история-изменений-стратегий)
3. [Результаты оптимизации](#результаты-оптимизации)
4. [Технические улучшения](#технические-улучшения)
5. [Текущее состояние](#текущее-состояние)
6. [Следующие шаги](#следующие-шаги)

---

## Обзор проекта

Проект посвящен разработке и оптимизации торговых стратегий для рынка Forex с использованием бэктестинга и машинного обучения.

### Основные стратегии

1. **Carry Momentum Strategy** - Стратегия, использующая комбинацию тренда (EMA, ADX) и свопа для входа в позиции
2. **Momentum Breakout Strategy** - Стратегия прорыва на основе импульса
3. **Mean Reversion Strategy** - Стратегия возврата к среднему

### Инструменты и таймфреймы

- **Инструменты:** EURUSD, GBPUSD, USDJPY
- **Таймфреймы:** m15 (15 минут), h1 (1 час), h4 (4 часа)

---

## История изменений стратегий

### Carry Momentum Strategy

#### Версия 1.0 (Исходная)
- `atr_multiplier`: 1.8
- `min_adx`: 22.0
- `min_pos_di_advantage`: 3.0
- `trend_confirmation_bars`: 3
- `risk_reward_ratio`: 2.5
- `avoid_hours`: [7, 8, 9, 11, 15, 16, 17, 21, 22, 23, 0, 1, 2, 3, 4, 5] - фильтр по часам дня
- `enable_short_trades`: False

**Результаты:**
- EURUSD m15: Recovery Factor = 0.19, Profit Factor = 1.11, Sharpe = 0.80
- Всего сделок: 19
- Win Rate: 52.6%

#### Версия 1.1 (Первая оптимизация)
**Изменения:**
- `atr_multiplier`: 1.8 → 1.5
- `min_adx`: 22.0 → 16.0
- `min_pos_di_advantage`: 3.0 → 1.0
- `trend_confirmation_bars`: 3 → 3 (без изменений)
- `risk_reward_ratio`: 2.5 → 3.0

**Результаты:**
- EURUSD m15: Recovery Factor = 10.60, Profit Factor = 6.51, Sharpe = 13.72
- Всего сделок: 12
- Win Rate: 83.3%

#### Версия 1.2 (Ослабление фильтров)
**Изменения:**
- `min_adx`: 18.0 → 14.0 (ослаблено для увеличения количества сделок)
- `trend_confirmation_bars`: 4 → 2 (ослаблено для увеличения количества сделок)
- `avoid_hours`: **ПОЛНОСТЬЮ УДАЛЕН** - стратегия теперь торгует в любые часы
- `atr_multiplier`: 1.8 → 2.2 (увеличено для большего расстояния стоп-лосса)

**Причина изменений:**
- Все убыточные сделки закрывались по стоп-лоссу → увеличен `atr_multiplier`
- Недостаточно сделок → ослаблены фильтры `min_adx` и `trend_confirmation_bars`
- Фильтр `avoid_hours` ограничивал возможности стратегии → удален

#### Версия 1.3 (Текущая)
**Параметры по умолчанию:**
- `atr_multiplier`: 2.2
- `min_adx`: 14.0
- `min_pos_di_advantage`: 1.0
- `trend_confirmation_bars`: 2
- `risk_reward_ratio`: 2.5
- `enable_short_trades`: False (SHORT сделки отключены, так как плохо работают)
- `avoid_hours`: **УДАЛЕН**

**Дополнительные фильтры:**
- Фильтр по волатильности: `min_volatility_pct` = 0.08, `max_volatility_pct` = 0.15
- Фильтр по RSI: `min_rsi_long` = 50.0, `max_rsi_short` = 50.0
- Фильтр по сессиям для специфичных инструментов (USDJPY, AUDJPY)

---

## Результаты оптимизации

### Методы оптимизации

#### 1. Grid Search (Полный перебор)
- **Использование:** Начальные оптимизации, двухэтапная оптимизация
- **Преимущества:** Полный охват пространства параметров
- **Недостатки:** Медленно для больших сеток параметров

#### 2. Two-Stage Optimization (Двухэтапная оптимизация)
- **Этап 1:** Грубая сетка параметров для быстрого поиска области оптимума
- **Этап 2:** Точная сетка вокруг лучших параметров из этапа 1
- **Использование:** Основной метод до внедрения генетического алгоритма

#### 3. Genetic Algorithm (Генетический алгоритм) ⭐
- **Библиотека:** DEAP (Distributed Evolutionary Algorithms in Python)
- **Параметры:**
  - Поколения: 20 (fast_mode: 10)
  - Размер популяции: 50 (fast_mode: 30)
  - Вероятность мутации: 0.2 (адаптивная)
  - Вероятность скрещивания: 0.7 (адаптивная)
  - Размер турнира: 3
  - Элитизм: 5 лучших особей
- **Оптимизации для ускорения:**
  - ✅ **Раннее прекращение (Early Stopping):** Остановка если лучший результат не улучшается N поколений подряд
  - ✅ **In-memory кэш:** Кэширование результатов в памяти для текущей сессии
  - ✅ **Быстрая оценка (Fast Evaluation):** Использование подвыборки данных (последние 6 месяцев) для начальных поколений
  - ✅ **Адаптивные параметры:** Высокая мутация в начале, низкая в конце
  - ✅ **Параллелизация:** Использование 12 CPU ядер через ProcessPoolExecutor
- **Преимущества:** Быстрее чем Grid Search для больших пространств параметров, лучше находит глобальные оптимумы

### Результаты оптимизации Carry Momentum Strategy

#### EURUSD m15

**Grid Search (Two-Stage):**
```json
{
  "best_score": 10.598559189613272,
  "best_params": {
    "atr_multiplier": 1.5,
    "min_adx": 16,
    "min_pos_di_advantage": 1.0,
    "trend_confirmation_bars": 3,
    "risk_reward_ratio": 3.0
  }
}
```

**Метрики:**
- Recovery Factor: 10.60
- Profit Factor: 6.51
- Sharpe Ratio: 13.72
- Total Trades: 12
- Win Rate: 83.3%
- Net PnL: +370.81

**Примечание:** Recovery Factor = 1000.0 в некоторых результатах указывает на проблему с расчетом метрики (нулевой drawdown или недостаточно сделок). Такие результаты фильтруются при анализе.

#### GBPUSD m15

**Genetic Algorithm (v2):**
```json
{
  "best_score": 2.0664923425451978,
  "best_params": {
    "atr_multiplier": 2.7937308944835535,
    "min_adx": 14,
    "min_pos_di_advantage": 0.5180633113453625,
    "trend_confirmation_bars": 5,
    "risk_reward_ratio": 3.4554906961816316,
    "enable_short_trades": false
  },
  "optimized_at": "2025-11-08T19:07:54.063519"
}
```

**Метрики:**
- Recovery Factor: 2.07
- Оптимизация проведена с использованием генетического алгоритма
- График сделок сохранен: `research/plots/carry_momentum_gbpusd_m15_best_genetic_v2.png`

#### USDJPY m15

**Genetic Algorithm (Fast Mode):**
```json
{
  "best_score": 2.662803078697867,
  "best_params": {
    "atr_multiplier": 3.4359690563514174,
    "min_adx": 16,
    "min_pos_di_advantage": 3.9291579707320747,
    "trend_confirmation_bars": 2,
    "risk_reward_ratio": 4.0,
    "enable_short_trades": false
  },
  "optimized_at": "2025-11-08T19:24:17.018667"
}
```

**Метрики:**
- Recovery Factor: 2.66
- Оптимизация проведена с использованием генетического алгоритма в fast_mode
- График сделок сохранен: `research/plots/carry_momentum_usdjpy_m15_best_genetic.png`
- Всего протестировано комбинаций: 450

### Сравнение методов оптимизации

| Метод | Скорость | Качество результатов | Использование |
|-------|----------|----------------------|---------------|
| Grid Search | Медленно | Хорошо для малых сеток | Начальные оптимизации |
| Two-Stage | Средне | Хорошо | Основной метод до GA |
| Genetic Algorithm | Быстро | Отлично | Текущий основной метод |

---

## Технические улучшения

### 1. Система оптимизации

#### HyperparameterOptimizer (Grid Search)
- **Файл:** `src/backtesting/optimization.py`
- **Функции:**
  - Кэширование результатов в файлы
  - Параллелизация через ProcessPoolExecutor
  - Поддержка двухэтапной оптимизации
  - Обработка Recovery Factor = inf (ограничение до 100.0)

#### GeneticOptimizer (Genetic Algorithm)
- **Файл:** `src/backtesting/genetic_optimization.py`
- **Функции:**
  - Генетический алгоритм на основе DEAP
  - Параллелизация через ProcessPoolExecutor (12 ядер)
  - In-memory кэш для ускорения
  - Быстрая оценка с подвыборкой данных
  - Адаптивные параметры мутации и скрещивания
  - Раннее прекращение при отсутствии улучшений
  - Промежуточное сохранение результатов

### 2. Скрипты оптимизации

#### optimize_strategy.py
- **Функции:**
  - `optimize_carry_momentum()` - Grid Search оптимизация
  - `optimize_carry_momentum_two_stage()` - Двухэтапная оптимизация
  - `optimize_carry_momentum_genetic()` - Генетическая оптимизация
  - `check_running_optimization()` - Проверка запущенных процессов
- **Параметры командной строки:**
  - `--use-genetic` - Использовать генетический алгоритм
  - `--fast-mode` - Быстрый режим (меньше поколений и популяция)
  - `--n-jobs 12` - Количество параллельных процессов

#### optimize_carry_momentum_all.py
- Массовая оптимизация на всех комбинациях инструментов и таймфреймов
- Поддержка генетического алгоритма

### 3. Визуализация результатов

#### visualize_trades.py
- **Функции:**
  - Построение графиков сделок на ценовом графике
  - Отображение точек входа/выхода
  - Отображение стоп-лоссов и тейк-профитов
  - Сохранение графиков в PNG
- **Параметры:**
  - `--params-file` - Файл с параметрами стратегии
  - `--output` - Путь для сохранения графика

### 4. Мониторинг оптимизации

#### monitor_optimization.py
- Мониторинг прогресса оптимизации в реальном времени
- Чтение промежуточных результатов из JSON файлов

### 5. Обработка ошибок

- Обработка Recovery Factor = inf (ограничение до 100.0)
- Фильтрация результатов с недостаточным количеством сделок
- Проверка на дублирующиеся процессы оптимизации
- Правильное завершение ProcessPoolExecutor даже при ошибках

---

## Текущее состояние

### Завершенные задачи ✅

1. ✅ Реализация Carry Momentum Strategy
2. ✅ Реализация системы бэктестинга
3. ✅ Реализация Grid Search оптимизации
4. ✅ Реализация двухэтапной оптимизации
5. ✅ Реализация генетического алгоритма оптимизации
6. ✅ Параллелизация оптимизации (12 ядер)
7. ✅ Оптимизация генетического алгоритма (early stopping, кэш, fast evaluation)
8. ✅ Оптимизация параметров для EURUSD m15
9. ✅ Оптимизация параметров для GBPUSD m15 (генетический алгоритм)
10. ✅ Оптимизация параметров для USDJPY m15 (генетический алгоритм, fast mode)
11. ✅ Визуализация сделок для оптимизированных стратегий
12. ✅ Ослабление фильтров стратегии (min_adx, trend_confirmation_bars)
13. ✅ Удаление фильтра avoid_hours
14. ✅ Добавление поддержки SHORT сделок в сетку параметров

### Текущие файлы результатов

**Конфигурации:**
- `research/configs/optimized/carry_momentum_EURUSD_m15.json`
- `research/configs/optimized/carry_momentum_GBPUSD_m15.json`
- `research/configs/optimized/carry_momentum_USDJPY_m15.json`
- `research/configs/optimized/best_params_gbpusd_m15_v2.json`

**Все результаты оптимизации:**
- `research/configs/optimized/carry_momentum_EURUSD_m15_all_results.json`
- `research/configs/optimized/carry_momentum_GBPUSD_m15_all_results.json`
- `research/configs/optimized/carry_momentum_USDJPY_m15_all_results.json`

**Графики:**
- `research/plots/carry_momentum_gbpusd_m15_best_genetic_v2.png`
- `research/plots/carry_momentum_usdjpy_m15_best_genetic.png`

### Параметры оптимизации (Genetic Algorithm)

**Сетка параметров для Carry Momentum:**
```python
{
    "atr_multiplier": [1.5, 2.0, 2.5, 3.0, 3.5, 4.0],
    "min_adx": [14, 16, 18, 20, 22, 24],
    "min_pos_di_advantage": [0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0],
    "trend_confirmation_bars": [2, 3, 4, 5],
    "risk_reward_ratio": [2.0, 2.5, 3.0, 3.5, 4.0],
    "enable_short_trades": [False, True]  # Добавлено в сетку
}
```

**Метрика оптимизации:** Recovery Factor

---

## Следующие шаги

### Краткосрочные задачи

1. ⏳ Протестировать Carry Momentum на других таймфреймах (h1, h4)
2. ⏳ Протестировать Carry Momentum на других инструментах
3. ⏳ Провести walk-forward валидацию оптимизированных стратегий
4. ⏳ Включить SHORT сделки в оптимизацию и протестировать результаты
5. ⏳ Проанализировать детальную статистику сделок для USDJPY m15

### Среднесрочные задачи

1. ⏳ Расширить сетку параметров оптимизации
2. ⏳ Реализовать адаптивные параметры стратегии
3. ⏳ Добавить учет спреда в бэктестере (частично реализовано)
4. ⏳ Реализовать портфельный подход (несколько стратегий одновременно)
5. ⏳ Добавить риск-менеджмент на уровне портфеля
6. ⏳ **Автоматический выбор оптимального `n_jobs`:** Реализовать автоматический выбор оптимального количества параллельных процессов на основе количества физических и логических ядер CPU. Добавить параметр для быстрого тестирования разных значений `n_jobs` с измерением производительности. Рекомендация: для систем с Hyper-Threading (12 физических / 24 логических ядер) оптимально использовать 16 процессов для баланса между использованием Hyper-Threading и overhead от переключения контекста.

### Долгосрочные задачи

1. ⏳ Реализовать forward testing на реальных данных
2. ⏳ Интеграция с брокером для paper trading
3. ⏳ Реализовать автоматическую реоптимизацию стратегий
4. ⏳ Добавить машинное обучение для предсказания сигналов
5. ⏳ Реализовать систему мониторинга производительности в реальном времени

---

## Заметки и наблюдения

### Проблемы и решения

1. **Проблема:** Recovery Factor = inf или очень большие значения
   - **Причина:** Нулевой drawdown или недостаточно сделок
   - **Решение:** Ограничение Recovery Factor до 100.0, фильтрация результатов с недостаточным количеством сделок

2. **Проблема:** Медленная оптимизация
   - **Решение:** Параллелизация на 12 ядер, генетический алгоритм, быстрая оценка, in-memory кэш
   - **Текущая настройка:** Используется `n_jobs=12` (равно количеству физических ядер)
   - **Рекомендация:** Для систем с Hyper-Threading (12 физических / 24 логических ядер) рекомендуется протестировать `n_jobs=16` для частичного использования Hyper-Threading с ожидаемым приростом производительности 10-20%

3. **Проблема:** Множественные процессы оптимизации
   - **Решение:** Добавлена проверка `check_running_optimization()` для предотвращения дублирования

4. **Проблема:** Все убыточные сделки закрываются по стоп-лоссу
   - **Решение:** Увеличен `atr_multiplier` с 1.8 до 2.2

5. **Проблема:** Недостаточно сделок
   - **Решение:** Ослаблены фильтры `min_adx` (18→14) и `trend_confirmation_bars` (4→2), удален `avoid_hours`

### Наблюдения

1. **EURUSD m15:** Показывает лучшие результаты с Recovery Factor = 10.60, но с небольшим количеством сделок (12)
2. **GBPUSD m15:** Recovery Factor = 2.07, требует дальнейшей оптимизации
3. **USDJPY m15:** Recovery Factor = 2.66, хорошие результаты с генетическим алгоритмом
4. **SHORT сделки:** Отключены по умолчанию, так как плохо работают. Добавлены в сетку параметров для тестирования
5. **Генетический алгоритм:** Значительно быстрее Grid Search и находит лучшие результаты

### Рекомендации

1. Продолжить оптимизацию на других инструментах и таймфреймах
2. Протестировать включение SHORT сделок с оптимизированными параметрами
3. Провести детальный анализ убыточных сделок для улучшения стратегии
4. Реализовать адаптивные параметры в зависимости от рыночных условий
5. Добавить фильтры по времени дня на основе статистики убыточных сделок

---

## Контакты и ссылки

- **Репозиторий:** GitHub (forex-research)
- **Документация:** `docs/`
- **Результаты оптимизации:** `research/configs/optimized/`
- **Графики:** `research/plots/`

---

**Примечание:** Этот журнал обновляется по мере выполнения работ над проектом. Все важные изменения, результаты оптимизации и наблюдения должны быть задокументированы здесь.

