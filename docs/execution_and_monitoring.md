# Исполнение стратегий и мониторинг

## 1. Архитектура контура исполнения
- **Execution Router**: маршрутизирует заявки в зависимости от брокера/биржи, контролирует лимиты и скорость отправки.
- **Order Manager**: агрегирует заявки, управляет жизненным циклом (создание, изменение, отмена), хранит журнал.
- **Risk Guard**: онлайн-проверки (лимиты плеча, объёмов, стоп-триггеры) до отправки ордеров.
- **Market Data Listener**: подписка на потоковые котировки и обновление внутренних моделей цен.
- **Strategy Runner**: контейнер для исполняемых стратегий; обрабатывает сигналы, генерирует заявки, взаимодействует через очередь сообщений.

## 2. Пайплайн развертывания
1. **Paper Trading**: стратегии запускаются в симуляторе с реальными потоками цен.
2. **Shadow Mode**: ордера формируются, но не отправляются; сравнение с реальным рынком.
3. **Staged Rollout**: включение в production на 10% капитала → 50% → 100% при отсутствии инцидентов.
4. **Rollback Plan**: автоматическое отключение через флаг в конфигурации или CLI `execution/cli.py disable --strategy <name>`.

## 3. Мониторинг
- **Dashboards**:
  - `execution_latency` — распределение задержек по этапам (стратегия → очередь → брокер).
  - `fill_rate` — процент исполнения ордеров, причин отказов.
  - `pnl_live` — онлайн PnL и отклонение от бэктеста.
  - `risk_limits` — текущее плечо, VAR, экспозиции.
- **Данные**:
  - Метрики собираются в Prometheus через экспортёр.
  - Визуализация в Grafana/Plotly Dash.
- **Алерты**:
  - Опоздание ордера > 5 секунд.
  - Частота отказов брокера > 3% за 15 минут.
  - Расхождение бумажного и реального PnL > 2σ.

## 4. Отчётность и итерации
- **Daily Runbook**: проверка здоровья сервисов, сверка позиций, анализ аномалий.
- **Weekly Review**: оценка эффективности стратегий, корректировка параметров, анализ отклонений.
- **Post-Deployment Review**: через 30 дней после запуска стратегия проходит оценку KPI, решение о масштабировании.
- **Change Management**: все обновления оформляются через Pull Request + Change Log, с обязательным A/B сравнением.

## 5. Инструменты
- **CLI** (`execution/cli.py`):
  - `status` — текущее состояние стратегий и лимиты.
  - `enable/disable` — управление стратегиями.
  - `throttle` — изменение лимитов отправки ордеров.
- **Monitoring Config**: YAML-файл с описанием метрик, порогов и каналов уведомлений.
- **Incident Playbook**: чек-лист действий при отказах брокера, задержках данных, превышении лимитов.

