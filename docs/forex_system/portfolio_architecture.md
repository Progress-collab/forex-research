# Архитектура портфеля и пайплайна сигналов (FXPro cTrader)

## Распределение капитала
- **Стартовый капитал:** 100% (ориентир 100k USD эквивалент).
- **Робот A (Momentum Breakout):** 40% капитала, максимум 4 одновременных позиции, риск на сделку ≤ 0.75%.
- **Робот B (Mean Reversion):** 35% капитала, 6 позиций, риск на сделку ≤ 0.6%.
- **Робот C (Carry+Momentum):** 25% капитала, 3 позиции, риск на сделку ≤ 0.8%.
- **Резерв ликвидности:** не менее 10% капитала свободно для покрытия маржи и вариаций свопов.
- **Лимиты плеча:** совокупное плечо портфеля ≤ 4x, по каждой стратегии ≤ 2.5x.

### Размеры позиций и стопы

| Инструмент | ATR (M15) | Брейкаут (стоп = 2×ATR) | Mean Reversion (1.2×ATR) | Carry (1.5×ATR) | Комментарии |
|------------|-----------|-------------------------|---------------------------|-----------------|-------------|
| EURUSD     | 4.5 пипса | расчётный размер 8.4 лота ⇒ **кап 2 лота** | 11.2 ⇒ **кап 1.5 лота** | не используется | Ограничиваем размер из-за маржи и риска корреляции. |
| GBPUSD     | 6.8 пипса | расчёт 5.5 ⇒ **кап 1.5 лота** | 7.4 ⇒ **кап 1.0 лота** | — | Более резкие движения, оставляем запас по стопам. |
| USDJPY     | 8.4 пипса | расчёт 4.9 ⇒ **кап 1.2 лота** | 6.5 ⇒ **кап 1.0 лота** | 7.0 ⇒ **кап 1.0 лота** | Плечо снижаем из‑за ночных гэпов. |
| XAUUSD     | 52 $/0.1  | расчёт 0.72 ⇒ **кап 0.5 лота** | 0.96 ⇒ **кап 0.35 лота** | — | Высокая волатильность, стоп ≥ 100 $ (≈10 пипсов золота). |

> Капы применяются после расчёта размера по риск-модели. Если вычисленный размер ниже лимита — используем его, иначе режем позицию и фиксируем остаток в журнале.

## Управление риском
- **Stop-out уровни:** ежедневный VAR (95%, 1д) ≤ 2% капитала портфеля; при превышении — сокращение объёма на 50%.
- **Drawdown-контроль:** падение капитала стратегии на 8% ⇒ отключение и ревизия.
- **Синхронизация позиций:** не допускается противоположная экспозиция по одной паре сразу в двух роботах (конфликтующие сигналы отбрасываются).

## Пайплайн сигналов
1. **Данные:**
   - Исторические свечи и фиды — через существующий `src/data_pipeline` (MOEX + FXPro). Для FXPro используем `scripts/fetch_ctrader_trendbars.py` (live по умолчанию, `--environment demo` при наличии демо-кредов).
   - Потоковые котировки — адаптер cTrader Open API (планируется в рамках прототипирования).
2. **Фичи:**
   - Расчёт индикаторов (ATR, RSI, EMA, ADX) в отдельном модуле `src/signals/features.py`.
   - Фичи сохраняются в parquet/duckdb для повторного использования.
3. **Генерация сигналов:**
   - Каждый робот реализуется как класс `Strategy` с методом `generate_signals(data_slice) -> list[Signal]`.
   - Сигналы нормализуются в единый формат JSON (см. ниже).
4. **Фильтры и конфликт-резолвер:**
   - Глобальный фильтр по риск-лимитам (проверка VAR, плеча).
   - Resolver снимает дубли и конфликты (приоритет робота: Momentum > Mean Reversion > Carry).
5. **Оркестрация:**
   - Планировщик Prefect запускает пайплайн каждые 15 минут для роботов A/B и раз в час для робота C.
   - Результаты логируются в MLflow (метрики) и TimescaleDB (история сигналов).

## Формат сигналов
```json
{
  "strategy_id": "momentum_breakout",
  "generated_at": "2025-11-07T09:15:00Z",
  "instrument": "EURUSD",
  "direction": "LONG",
  "entry_price": 1.0765,
  "stop_loss": 1.0745,
  "take_profit": 1.0795,
  "notional": 25000,
  "confidence": 0.72,
  "ttl_minutes": 60
}
```

## Передача в исполнение
- Сигналы складываются в Kafka topic `fxpro.signals` (или таблицу в Postgres) → 소비руются модулем `src/execution`.
- Execution Engine преобразует сигнал в ордер cTrader Open API (REST/WebSocket, FIX) с учётом текущей ликвидности.
- Все действия логируются в `state/execution_strategies.json` и Prometheus метриках.

## Документооборот
- Каждая стратегия имеет паспорт (`docs/forex_system/passports/<strategy>.md`) с настройками и параметрами.
- Изменения в лимитах фиксируются через Change Log и утверждаются Risk Manager.

